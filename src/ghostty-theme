#!/bin/bash
# Ghostty Theme Switcher
# https://github.com/yourusername/ghostty-theme-switch

set -e

VERSION="2.0.0"

# Config file location
CONFIG_FILE="$HOME/Library/Application Support/com.mitchellh.ghostty/config"
if [[ ! -f "$CONFIG_FILE" ]]; then
    CONFIG_FILE="$XDG_CONFIG_HOME/ghostty/config"
fi
if [[ ! -f "$CONFIG_FILE" ]]; then
    CONFIG_FILE="$HOME/.config/ghostty/config"
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Find Ghostty executable
if [[ "$OSTYPE" == "darwin"* ]] && [[ -x "/Applications/Ghostty.app/Contents/MacOS/ghostty" ]]; then
    GHOSTTY_EXEC="/Applications/Ghostty.app/Contents/MacOS/ghostty"
elif [[ "$OSTYPE" == "darwin"* ]] && [[ -x "$HOME/Applications/Ghostty.app/Contents/MacOS/ghostty" ]]; then
    GHOSTTY_EXEC="$HOME/Applications/Ghostty.app/Contents/MacOS/ghostty"
else
    GHOSTTY_EXEC="ghostty"
fi

# Cleanup
cleanup() {
    rm -f /tmp/ghostty-theme-selected.txt
}
trap cleanup EXIT

# Usage
usage() {
    echo -e "${CYAN}Ghostty Theme Switcher${NC} v${VERSION}"
    echo ""
    echo "Usage:"
    echo "  ghostty-theme                    Interactive theme selector"
    echo "  ghostty-theme list               List all themes"
    echo "  ghostty-theme current            Show current theme"
    echo "  ghostty-theme <theme-name>       Apply specific theme"
    echo "  ghostty-theme random             Apply random theme"
    echo "  ghostty-theme light/dark         Apply light/dark theme"
    echo "  ghostty-theme version            Show version"
    echo ""
    echo "Examples:"
    echo "  ghostty-theme                    # Built-in theme browser"
    echo "  ghostty-theme \"Dracula\"          # Apply Dracula theme"
    echo "  ghostty-theme random             # Random theme"
}

# Get current theme
get_current_theme() {
    if [[ -f "$CONFIG_FILE" ]]; then
        awk -F'= *' '/^theme[[:space:]]*=/ {print $2}' "$CONFIG_FILE" | tr -d '"' | tr -d "'"
    else
        echo "Unknown"
    fi
}

# List themes
list_themes() {
    local current=$(get_current_theme)
    echo -e "${BOLD}Available themes:${NC}"
    echo ""
    ghostty +list-themes 2>/dev/null | sed 's/ (resources)$//' | sort | while read -r theme; do
        if [[ "$theme" == "$current" ]]; then
            echo -e "  ${GREEN}●${NC} $theme ${CYAN}(current)${NC}"
        else
            echo -e "  ○ $theme"
        fi
    done
}

# Apply theme to config
apply_theme() {
    local new_theme="$1"
    cp "$CONFIG_FILE" "$CONFIG_FILE.bak"

    if grep -qE "^theme[[:space:]]*=" "$CONFIG_FILE"; then
        awk -v new_theme="$new_theme" '/^theme[[:space:]]*=/ {$0 = "theme = " new_theme} 1' "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
    else
        echo "theme = $new_theme" >> "$CONFIG_FILE"
    fi

    echo -e "${GREEN}✓ Applied: ${BOLD}$new_theme${NC}"
    echo -e "${YELLOW}Press ${BOLD}Cmd+Shift+${NC},${YELLOW} to reload${NC}"
}

# Get all themes as array
get_themes_array() {
    local themes=()
    while IFS= read -r line; do
        themes+=("$line")
    done < <(ghostty +list-themes 2>/dev/null | sed 's/ (resources)$//' | sort)
    printf '%s\n' "${themes[@]}"
}

# Apply theme directly
apply_direct() {
    local new_theme="$1"

    # Verify theme exists
    if ! get_themes_array | grep -qx "$new_theme"; then
        echo -e "${RED}Error: Theme '$new_theme' not found${NC}" >&2
        echo -e "${YELLOW}Use 'ghostty-theme list' to see available themes${NC}" >&2
        exit 1
    fi

    apply_theme "$new_theme"
}

# Set random theme
set_random_theme() {
    local all_themes=($(get_themes_array))
    local count=${#all_themes[@]}
    apply_theme "${all_themes[$((RANDOM % count))]}"
}

# Set light/dark theme
set_mode_theme() {
    local mode="$1"
    local theme_name="Github Light"
    [[ "$mode" == "dark" ]] && theme_name="Dracula"
    apply_theme "$theme_name"
}

# Quick theme selector using fzf
quick_select() {
    if ! command -v fzf &>/dev/null; then
        echo -e "${YELLOW}fzf not found. Using built-in selector instead...${NC}"
        echo ""
        sleep 1
        # Fall back to built-in
        exec "$GHOSTTY_EXEC" +list-themes
        return
    fi

    local current=$(get_current_theme)
    local selected=$(get_themes_array | \
        fzf --height=50% \
            --prompt="Select theme: " \
            --query="$current" \
            --header="[Enter] to apply, [Esc] to cancel" \
            --border=rounded \
            --preview="echo 'Theme: {}'" \
            --preview-window=down:1:hidden)

    if [[ -n "$selected" ]]; then
        apply_theme "$selected"
    else
        echo "No theme selected"
    fi
}

# Main
case "$1" in
    ""|"-i"|"--interactive")
        # Use Ghostty's built-in theme browser
        echo -e "${CYAN}Opening Ghostty theme browser...${NC}"
        echo -e "${YELLOW}(Use F1 for help, Esc to exit, Enter to select)${NC}"
        echo ""
        exec "$GHOSTTY_EXEC" +list-themes
        ;;
    "list"|"--list"|"-l")
        list_themes
        ;;
    "current"|"--current"|"-c")
        echo -e "${CYAN}Current theme:${NC} ${BOLD}$(get_current_theme)${NC}"
        ;;
    "random"|"--random"|"-r")
        set_random_theme
        ;;
    "light"|"--light")
        set_mode_theme "light"
        ;;
    "dark"|"--dark")
        set_mode_theme "dark"
        ;;
    "quick"|"--quick"|"-q")
        quick_select
        ;;
    "version"|"--version"|"-v")
        echo "ghostty-theme v${VERSION}"
        ;;
    "help"|"--help"|"-h")
        usage
        ;;
    *)
        apply_direct "$*"
        ;;
esac

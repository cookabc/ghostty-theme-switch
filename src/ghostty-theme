#!/bin/bash
# Ghostty Theme Switcher
# https://github.com/yourusername/ghostty-theme-switch

set -e

VERSION="1.3.0"

# Config file location
CONFIG_FILE="$HOME/Library/Application Support/com.mitchellh.ghostty/config"
if [[ ! -f "$CONFIG_FILE" ]]; then
    CONFIG_FILE="$XDG_CONFIG_HOME/ghostty/config"
fi
if [[ ! -f "$CONFIG_FILE" ]]; then
    CONFIG_FILE="$HOME/.config/ghostty/config"
fi

# Temp directory for preview
PREVIEW_DIR="${TMPDIR:-/tmp}/ghostty-theme-preview"
PREVIEW_CONFIG="$PREVIEW_DIR/config"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Detect platform
[[ "$OSTYPE" == "darwin"* ]] && PLATFORM="macos" || PLATFORM="linux"

# Find Ghostty executable
if [[ "$PLATFORM" == "macos" ]] && [[ -x "/Applications/Ghostty.app/Contents/MacOS/ghostty" ]]; then
    GHOSTTY_EXEC="/Applications/Ghostty.app/Contents/MacOS/ghostty"
elif [[ "$PLATFORM" == "macos" ]] && [[ -x "$HOME/Applications/Ghostty.app/Contents/MacOS/ghostty" ]]; then
    GHOSTTY_EXEC="$HOME/Applications/Ghostty.app/Contents/MacOS/ghostty"
else
    GHOSTTY_EXEC="ghostty"
fi

# Cleanup
cleanup() {
    rm -f "$PREVIEW_CONFIG"
}
trap cleanup EXIT

# Usage
usage() {
    echo -e "${CYAN}Ghostty Theme Switcher${NC} v${VERSION}"
    echo ""
    echo "Usage:"
    echo "  ghostty-theme                    Interactive theme selector with live preview"
    echo "  ghostty-theme list               List all themes"
    echo "  ghostty-theme current            Show current theme"
    echo "  ghostty-theme <theme-name>       Preview & apply specific theme"
    echo "  ghostty-theme random             Preview random theme"
    echo "  ghostty-theme light/dark         Preview light/dark themes"
    echo "  ghostty-theme --no-preview <name> Apply directly"
    echo ""
    echo "Interactive keys:"
    echo "  ↑↓ - Navigate    Enter - Apply    Esc/q - Cancel"
    echo "  PgUp/PgDn - Page    Home/End - First/Last"
}

# Get current theme
get_current_theme() {
    if [[ -f "$CONFIG_FILE" ]]; then
        awk -F'= *' '/^theme[[:space:]]*=/ {print $2}' "$CONFIG_FILE" | tr -d '"' | tr -d "'"
    else
        echo "Unknown"
    fi
}

# Get all themes
get_all_themes() {
    ghostty +list-themes 2>/dev/null | sed 's/ (resources)$//' | sort
}

# List themes
list_themes() {
    local current=$(get_current_theme)
    echo -e "${BOLD}Available themes:${NC}"
    echo ""
    get_all_themes | while read -r theme; do
        if [[ "$theme" == "$current" ]]; then
            echo -e "  ${GREEN}●${NC} $theme ${CYAN}(current)${NC}"
        else
            echo -e "  ○ $theme"
        fi
    done
}

# Apply theme to config
apply_theme_to_config() {
    local new_theme="$1"
    cp "$CONFIG_FILE" "$CONFIG_FILE.bak"
    if grep -qE "^theme[[:space:]]*=" "$CONFIG_FILE"; then
        awk -v new_theme="$new_theme" '/^theme[[:space:]]*=/ {$0 = "theme = " new_theme} 1' "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
    else
        echo "theme = $new_theme" >> "$CONFIG_FILE"
    fi
    echo -e "${GREEN}✓ Applied: ${BOLD}$new_theme${NC}"
    echo -e "${YELLOW}Press ${BOLD}Cmd+Shift+${NC},${YELLOW} to reload${NC}"
}

# Create preview script with embedded theme
create_preview_script() {
    local theme="$1"
    local script_path="$PREVIEW_DIR/preview.sh"

    cat > "$script_path" <<EOF
#!/bin/bash
THEME_NAME="$theme"
CONFIG_FILE="$CONFIG_FILE"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

clear
echo -e "\${CYAN}\${BOLD}╔═══════════════════════════════════════════╗\${NC}"
echo -e "\${CYAN}\${BOLD}║           Theme Preview                     ║\${NC}"
echo -e "\${CYAN}\${BOLD}╚═══════════════════════════════════════════╝\${NC}"
echo ""
echo -e "\${BOLD}Theme:\${NC} \$THEME_NAME"
echo ""
echo -e "\${YELLOW}This is a preview. Do you want to keep this theme?\${NC}"
echo ""
echo -e "  \${GREEN}[y]${NC} Yes - Apply this theme"
echo -e "  \${RED}[n]${NC} No  - Cancel"
echo ""

while true; do
    read -p "Your choice (y/n): " choice
    case "\$choice" in
        y|Y)
            cp "\$CONFIG_FILE" "\$CONFIG_FILE.bak"
            if grep -qE "^theme[[:space:]]*=" "\$CONFIG_FILE"; then
                awk -v new_theme="\$THEME_NAME" '/^theme[[:space:]]*=/ {\$0 = "theme = " new_theme} 1' "\$CONFIG_FILE" > "\$CONFIG_FILE.tmp" && mv "\$CONFIG_FILE.tmp" "\$CONFIG_FILE"
            else
                echo "theme = \$THEME_NAME" >> "\$CONFIG_FILE"
            fi
            clear
            echo -e "\${GREEN}✓ Theme applied: \${BOLD}\$THEME_NAME\${NC}"
            echo -e "\${YELLOW}Press \${BOLD}Cmd+Shift+\${NC},\${YELLOW} to reload\${NC}"
            echo ""
            echo -e "\${YELLOW}Press Enter to close...\${NC}"
            read
            exit 0
            ;;
        n|N)
            exit 0
            ;;
        *)
            echo -e "\${RED}Invalid choice. Please enter y or n.\${NC}"
            ;;
    esac
done
EOF

    chmod +x "$script_path"
    echo "$script_path"
}

# Preview and apply theme
preview_and_apply_theme() {
    local new_theme="$1"

    if ! get_all_themes | grep -qx "$new_theme"; then
        echo -e "${RED}Error: Theme '$new_theme' not found${NC}" >&2
        echo -e "${YELLOW}Use 'ghostty-theme list' to see available themes${NC}" >&2
        exit 1
    fi

    mkdir -p "$PREVIEW_DIR"

    # Create temp config with theme
    echo "theme = $new_theme" > "$PREVIEW_CONFIG"

    # Create preview script
    local preview_script=$(create_preview_script "$new_theme")

    # Open preview window
    echo -e "${CYAN}Opening preview for: ${BOLD}$new_theme${NC}"
    "$GHOSTTY_EXEC" --config-file="$PREVIEW_CONFIG" -e "$preview_script"

    rm -f "$preview_script"
}

# Apply theme directly
apply_theme_directly() {
    local new_theme="$1"
    if ! get_all_themes | grep -qx "$new_theme"; then
        echo -e "${RED}Error: Theme '$new_theme' not found${NC}" >&2
        exit 1
    fi
    apply_theme_to_config "$new_theme"
}

# Set random theme
set_random_theme() {
    local themes=($(get_all_themes))
    local count=${#themes[@]}
    preview_and_apply_theme "${themes[$((RANDOM % count))]}"
}

# Set light/dark theme
set_mode_theme() {
    local mode="$1"
    local theme_name="Github Light"
    [[ "$mode" == "dark" ]] && theme_name="Dracula"

    if get_all_themes | grep -qx "$theme_name"; then
        preview_and_apply_theme "$theme_name"
    else
        echo -e "${RED}Error: Theme '$theme_name' not found${NC}" >&2
        exit 1
    fi
}

# Interactive selection
interactive_selection() {
    local themes=($(get_all_themes))
    local current=$(get_current_theme)
    local selected_idx=0
    local visible_count=18
    local scroll_offset=0

    # Find current theme index
    for ((i=0; i<${#themes[@]}; i++)); do
        if [[ "${themes[$i]}" == "$current" ]]; then
            selected_idx=$i
            break
        fi
    done

    # Set scroll offset
    scroll_offset=$((selected_idx > visible_count - 3 ? selected_idx - visible_count + 3 : 0))

    # Save terminal settings
    stty_save=$(stty -g 2>/dev/null || true)
    stty -icanon -echo 2>/dev/null || true
    trap 'stty "$stty_save" 2>/dev/null || true; exit 0' INT

    while true; do
        clear

        # Header
        echo -e "${CYAN}${BOLD}╔═══════════════════════════════════════════╗${NC}"
        echo -e "${CYAN}${BOLD}║       Ghostty Theme Switcher             ║${NC}"
        echo -e "${CYAN}${BOLD}╚═══════════════════════════════════════════╝${NC}"
        echo -e "${YELLOW}Current: ${BOLD}$current${NC}  |  ${GREEN}Selected: ${BOLD}${themes[$selected_idx]}${NC}"
        echo ""

        # Display visible themes
        local end=$((scroll_offset + visible_count))
        [[ $end -gt ${#themes[@]} ]] && end=${#themes[@]}

        for ((i=scroll_offset; i<end; i++)); do
            if [[ $i -eq $selected_idx ]]; then
                echo -e "${GREEN}▶${NC} ${BOLD}${themes[$i]}${NC}"
            else
                echo "  ${themes[$i]}"
            fi
        done

        # Footer
        echo ""
        echo -e "${BOLD}[$((selected_idx + 1))/${#themes[@]}]${NC}"
        echo ""
        echo -e "  ${GREEN}[↑↓]${NC} Navigate    ${GREEN}[Enter]${NC} Preview & Apply"
        echo -e "  ${YELLOW}[PgUp/PgDn]${NC} Page    ${YELLOW}[Home/End]${NC} First/Last"
        echo -e "  ${RED}[Esc/q]${NC} Cancel"
        echo ""

        # Read key
        read -n 1 key 2>/dev/null || key=""

        case "$key" in
            $'\x1b')
                read -n 2 -t 0.1 rest 2>/dev/null || rest=""
                case "$rest" in
                    '[A') ((selected_idx--));;
                    '[B') ((selected_idx++));;
                    '[5') read -n 1 -t 0.1 t 2>/dev/null; ((selected_idx -= visible_count));;
                    '[6') read -n 1 -t 0.1 t 2>/dev/null; ((selected_idx += visible_count));;
                    '[H') selected_idx=0;;
                    '[F') selected_idx=$((${#themes[@]} - 1));;
                    *)
                        stty "$stty_save" 2>/dev/null || true
                        echo "Cancelled"
                        exit 0
                        ;;
                esac
                ;;
            '')
                stty "$stty_save" 2>/dev/null || true
                preview_and_apply_theme "${themes[$selected_idx]}"
                exit 0
                ;;
            'q'|'Q')
                stty "$stty_save" 2>/dev/null || true
                echo "Cancelled"
                exit 0
                ;;
        esac

        # Bounds check
        [[ $selected_idx -lt 0 ]] && selected_idx=0
        [[ $selected_idx -ge ${#themes[@]} ]] && selected_idx=$((${#themes[@]} - 1))

        # Scroll
        [[ $selected_idx -lt $scroll_offset ]] && scroll_offset=$selected_idx
        [[ $selected_idx -ge $((scroll_offset + visible_count - 1)) ]] && scroll_offset=$((selected_idx - visible_count + 2))
    done
}

# Main
case "$1" in
    ""|"-i"|"--interactive") interactive_selection ;;
    "list"|"--list"|"-l") list_themes ;;
    "current"|"--current"|"-c") echo -e "${CYAN}Current theme:${NC} ${BOLD}$(get_current_theme)${NC}" ;;
    "random"|"--random"|"-r") set_random_theme ;;
    "light"|"--light") set_mode_theme "light" ;;
    "dark"|"--dark") set_mode_theme "dark" ;;
    "--no-preview")
        [[ -z "$2" ]] && echo -e "${RED}Error: --no-preview requires a theme name${NC}" >&2 && exit 1
        apply_theme_directly "$2"
        ;;
    "version"|"--version"|"-v") echo "ghostty-theme v${VERSION}" ;;
    "help"|"--help"|"-h") usage ;;
    *) preview_and_apply_theme "$*" ;;
esac

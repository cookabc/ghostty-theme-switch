#!/bin/bash
# Ghostty Theme Switcher
# A simple tool to switch Ghostty terminal themes with live preview
# https://github.com/yourusername/ghostty-theme-switch

set -e

VERSION="1.2.0"

# Config file location (macOS)
CONFIG_FILE="$HOME/Library/Application Support/com.mitchellh.ghostty/config"

# Fallback for Linux
if [[ ! -f "$CONFIG_FILE" ]]; then
    CONFIG_FILE="$XDG_CONFIG_HOME/ghostty/config"
fi

if [[ ! -f "$CONFIG_FILE" ]]; then
    CONFIG_FILE="$HOME/.config/ghostty/config"
fi

# Temp directory for preview state
PREVIEW_TMP_DIR="${TMPDIR:-/tmp}/ghostty-theme-preview"
PREVIEW_THEME_FILE="$PREVIEW_TMP_DIR/current_theme"
PREVIEW_ACTION_FILE="$PREVIEW_TMP_DIR/action"
PREVIEW_PID_FILE="$PREVIEW_TMP_DIR/preview_pid"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Detect platform
detect_platform() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    else
        echo "linux"
    fi
}

PLATFORM=$(detect_platform)

# Cleanup on exit
cleanup() {
    rm -f "$PREVIEW_THEME_FILE" "$PREVIEW_ACTION_FILE" "$PREVIEW_PID_FILE"
    # Kill preview window if running
    if [[ -f "$PREVIEW_PID_FILE" ]]; then
        local pid=$(cat "$PREVIEW_PID_FILE" 2>/dev/null)
        if [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null; then
            kill "$pid" 2>/dev/null || true
        fi
    fi
}
trap cleanup EXIT

# Print usage
usage() {
    echo -e "${CYAN}Ghostty Theme Switcher${NC} v${VERSION}"
    echo ""
    echo "Usage:"
    echo "  ghostty-theme                    Interactive theme selector with live preview"
    echo "  ghostty-theme list               List all available themes"
    echo "  ghostty-theme current            Show current theme"
    echo "  ghostty-theme <theme-name>       Preview & apply specific theme"
    echo "  ghostty-theme random             Preview & apply a random theme"
    echo "  ghostty-theme light/dark         Preview & apply light/dark mode theme"
    echo "  ghostty-theme --no-preview       Apply theme without preview"
    echo "  ghostty-theme version            Show version info"
    echo ""
    echo "Examples:"
    echo "  ghostty-theme                    # Interactive selection with arrow keys"
    echo "  ghostty-theme \"Dracula\"          # Preview and apply Dracula"
    echo "  ghostty-theme random             # Preview random theme"
    echo "  ghostty-theme --no-preview \"Nord\" # Apply directly"
}

# Get current theme
get_current_theme() {
    if [[ -f "$CONFIG_FILE" ]]; then
        awk -F'= *' '/^theme[[:space:]]*=/ {print $2}' "$CONFIG_FILE" | tr -d '"' | tr -d "'"
    else
        echo "Unknown"
    fi
}

# Get all available themes
get_all_themes() {
    ghostty +list-themes 2>/dev/null | sed 's/ (resources)$//' | sort
}

# List all themes
list_themes() {
    local current=$(get_current_theme)
    echo -e "${BOLD}Available themes:${NC}"
    echo ""

    get_all_themes | while read -r theme; do
        if [[ "$theme" == "$current" ]]; then
            echo -e "  ${GREEN}●${NC} $theme ${CYAN}(current)${NC}"
        else
            echo -e "  ○ $theme"
        fi
    done
}

# Apply theme to config (write to file)
apply_theme_to_config() {
    local new_theme="$1"

    # Backup config
    cp "$CONFIG_FILE" "$CONFIG_FILE.bak"

    # Update or add theme line
    if grep -qE "^theme[[:space:]]*=" "$CONFIG_FILE"; then
        awk -v new_theme="$new_theme" '/^theme[[:space:]]*=/ {$0 = "theme = " new_theme} 1' "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
    else
        echo "theme = $new_theme" >> "$CONFIG_FILE"
    fi

    echo -e "${GREEN}Applied theme: ${BOLD}$new_theme${NC}"
    echo -e "${YELLOW}Press ${BOLD}Cmd+Shift+${NC},${YELLOW} to reload${NC}"
}

# Start live preview window
start_preview_window() {
    local initial_theme="$1"

    mkdir -p "$PREVIEW_TMP_DIR"

    # Create the preview watcher script
    local watcher_script="$PREVIEW_TMP_DIR/watcher.sh"
    cat > "$watcher_script" <<'WATCHER_EOF'
#!/bin/bash
THEME_FILE="$1"
ACTION_FILE="$2"
PID_FILE="$3"
PLATFORM="$4"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

last_theme=""

while true; do
    # Read current theme from file
    if [[ -f "$THEME_FILE" ]]; then
        current_theme=$(cat "$THEME_FILE")
    else
        current_theme=""
    fi

    # Check for action from main window
    if [[ -f "$ACTION_FILE" ]]; then
        action=$(cat "$ACTION_FILE")
        case "$action" in
            "quit")
                rm -f "$ACTION_FILE"
                exit 0
                ;;
            "apply")
                # Apply theme and show success message
                if [[ -f "$THEME_FILE" ]]; then
                    theme_name=$(cat "$THEME_FILE")
                    clear
                    echo -e "${GREEN}✓ Theme applied: ${BOLD}$theme_name${NC}"
                    echo ""
                    echo -e "${YELLOW}Press ${BOLD}Cmd+Shift+${NC},${YELLOW} to reload other windows${NC}"
                    echo ""
                    echo -e "${YELLOW}Press Enter to close...${NC}"
                    read
                fi
                rm -f "$ACTION_FILE"
                exit 0
                ;;
        esac
    fi

    # Restart window if theme changed
    if [[ "$current_theme" != "$last_theme" ]] && [[ -n "$current_theme" ]]; then
        # Save current theme
        last_theme="$current_theme"

        # Relaunch self with new theme
        if [[ "$PLATFORM" == "macos" ]]; then
            # Open new window and exit current one
            open -na "Ghostty.app" --args --theme="$current_theme" -e "bash '$0' '$1' '$2' '$3' '$4'"
            exit 0
        else
            ghostty --theme="$current_theme" -e "bash '$0' '$1' '$2' '$3' '$4'" &
            exit 0
        fi
    fi

    # Display preview UI
    clear
    echo -e "${CYAN}${BOLD}╔═══════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}${BOLD}║           Live Preview                     ║${NC}"
    echo -e "${CYAN}${BOLD}╚═══════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${BOLD}Theme:${NC} $current_theme"
    echo ""
    echo -e "${YELLOW}Use arrow keys in the main window to browse themes${NC}"
    echo -e "${GREEN}Press Enter to apply, Esc/q to cancel${NC}"
    echo ""

    sleep 0.1
done
WATCHER_EOF

    chmod +x "$watcher_script"

    # Write initial theme
    echo "$initial_theme" > "$PREVIEW_THEME_FILE"

    # Clear previous action
    rm -f "$PREVIEW_ACTION_FILE"

    # Start preview window
    if [[ "$PLATFORM" == "macos" ]]; then
        open -na "Ghostty.app" --args --theme="$initial_theme" -e "'$watcher_script' '$PREVIEW_THEME_FILE' '$PREVIEW_ACTION_FILE' '$PREVIEW_PID_FILE' '$PLATFORM'"
    else
        ghostty --theme="$initial_theme" -e "'$watcher_script' '$PREVIEW_THEME_FILE' '$PREVIEW_ACTION_FILE' '$PREVIEW_PID_FILE' '$PLATFORM'" &
    fi
}

# Update preview theme
update_preview_theme() {
    local theme="$1"
    echo "$theme" > "$PREVIEW_THEME_FILE"
}

# Stop preview window
stop_preview_window() {
    echo "quit" > "$PREVIEW_ACTION_FILE" 2>/dev/null || true
    rm -f "$PREVIEW_THEME_FILE" "$PREVIEW_ACTION_FILE" "$PREVIEW_PID_FILE"
}

# Apply theme from preview
apply_from_preview() {
    local theme="$1"
    echo "apply" > "$PREVIEW_ACTION_FILE" 2>/dev/null || true

    # Apply to config
    apply_theme_to_config "$theme"

    # Clean up
    rm -f "$PREVIEW_THEME_FILE" "$PREVIEW_ACTION_FILE" "$PREVIEW_PID_FILE"
}

# Preview and apply theme (single preview mode)
preview_and_apply_theme() {
    local new_theme="$1"

    # Check if theme exists
    if ! get_all_themes | grep -qx "$new_theme"; then
        echo -e "${RED}Error: Theme '$new_theme' not found${NC}" >&2
        echo -e "${YELLOW}Use 'ghostty-theme list' to see available themes${NC}" >&2
        exit 1
    fi

    mkdir -p "$PREVIEW_TMP_DIR"

    # Create preview confirmation script
    local confirm_script="$PREVIEW_TMP_DIR/confirm.sh"
    cat > "$confirm_script" <<'PREVIEW_EOF'
#!/bin/bash
THEME_NAME="$1"
CONFIG_FILE="$2"
PREVIEW_STATE_FILE="$3"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

clear
echo -e "${CYAN}${BOLD}╔═══════════════════════════════════════════╗${NC}"
echo -e "${CYAN}${BOLD}║          Theme Preview                     ║${NC}"
echo -e "${CYAN}${BOLD}╚═══════════════════════════════════════════╝${NC}"
echo ""
echo -e "${BOLD}Theme:${NC} $THEME_NAME"
echo ""
echo -e "${YELLOW}This is a preview. Do you want to keep this theme?${NC}"
echo ""
echo -e "  ${GREEN}[y]${NC} Yes - Apply this theme"
echo -e "  ${RED}[n]${NC} No  - Cancel and close"
echo -e "  ${YELLOW}[r]${NC}    - Refresh preview"
echo ""

while true; do
    read -p "Your choice (y/n/r): " choice
    case "$choice" in
        y|Y)
            # Apply to config
            cp "$CONFIG_FILE" "$CONFIG_FILE.bak"
            if grep -qE "^theme[[:space:]]*=" "$CONFIG_FILE"; then
                awk -v new_theme="$THEME_NAME" '/^theme[[:space:]]*=/ {$0 = "theme = " new_theme} 1' "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
            else
                echo "theme = $THEME_NAME" >> "$CONFIG_FILE"
            fi
            echo "accepted" > "$PREVIEW_STATE_FILE"
            clear
            echo -e "${GREEN}✓ Theme applied: ${BOLD}$THEME_NAME${NC}"
            echo -e "${YELLOW}Press ${BOLD}Cmd+Shift+${NC},${YELLOW} to reload other windows${NC}"
            echo ""
            echo -e "${YELLOW}Press Enter to close this window...${NC}"
            read
            exit 0
            ;;
        n|N)
            echo "rejected" > "$PREVIEW_STATE_FILE"
            exit 0
            ;;
        r|R)
            # Refresh - just clear and redisplay
            clear
            echo -e "${CYAN}${BOLD}╔═══════════════════════════════════════════╗${NC}"
            echo -e "${CYAN}${BOLD}║          Theme Preview                     ║${NC}"
            echo -e "${CYAN}${BOLD}╚═══════════════════════════════════════════╝${NC}"
            echo ""
            echo -e "${BOLD}Theme:${NC} $THEME_NAME"
            echo ""
            echo -e "${YELLOW}This is a preview. Do you want to keep this theme?${NC}"
            echo ""
            echo -e "  ${GREEN}[y]${NC} Yes - Apply this theme"
            echo -e "  ${RED}[n]${NC} No  - Cancel and close"
            echo -e "  ${YELLOW}[r]${NC}    - Refresh preview"
            echo ""
            ;;
        *)
            echo -e "${RED}Invalid choice. Please enter y, n, or r.${NC}"
            ;;
    esac
done
PREVIEW_EOF

    chmod +x "$confirm_script"

    # Clear previous state
    PREVIEW_STATE_FILE="$PREVIEW_TMP_DIR/state"
    rm -f "$PREVIEW_STATE_FILE"

    # Open preview window with the theme
    if [[ "$PLATFORM" == "macos" ]]; then
        open -na "Ghostty.app" --args --theme="$new_theme" -e "'$confirm_script' '$new_theme' '$CONFIG_FILE' '$PREVIEW_STATE_FILE'"
    else
        ghostty --theme="$new_theme" -e "'$confirm_script' '$new_theme' '$CONFIG_FILE' '$PREVIEW_STATE_FILE'" &
    fi

    # Wait for user decision (with timeout)
    echo -e "${CYAN}Preview window opened${NC}"
    echo -e "${YELLOW}Waiting for your decision...${NC}"

    local waited=0
    local timeout=300  # 5 minutes max
    while [[ ! -f "$PREVIEW_STATE_FILE" ]] && [[ $waited -lt $timeout ]]; do
        sleep 0.5
        ((waited++))
    done

    if [[ -f "$PREVIEW_STATE_FILE" ]]; then
        local decision=$(cat "$PREVIEW_STATE_FILE")
        rm -f "$PREVIEW_STATE_FILE"

        if [[ "$decision" == "accepted" ]]; then
            echo -e "${GREEN}✓ Theme accepted and applied${NC}"
        else
            echo -e "${YELLOW}Theme preview cancelled${NC}"
        fi
    else
        echo -e "${YELLOW}Preview timed out or was closed${NC}"
    fi

    rm -f "$confirm_script"
}

# Apply theme directly (no preview)
apply_theme_directly() {
    local new_theme="$1"

    # Check if theme exists
    if ! get_all_themes | grep -qx "$new_theme"; then
        echo -e "${RED}Error: Theme '$new_theme' not found${NC}" >&2
        echo -e "${YELLOW}Use 'ghostty-theme list' to see available themes${NC}" >&2
        exit 1
    fi

    apply_theme_to_config "$new_theme"
}

# Set random theme
set_random_theme() {
    local themes=($(get_all_themes))
    local count=${#themes[@]}
    local index=$((RANDOM % count))
    preview_and_apply_theme "${themes[$index]}"
}

# Set light/dark theme
set_mode_theme() {
    local mode="$1"
    local theme_name

    if [[ "$mode" == "light" ]]; then
        theme_name="Github Light"
    else
        theme_name="Dracula"
    fi

    # Verify theme exists
    if get_all_themes | grep -qx "$theme_name"; then
        preview_and_apply_theme "$theme_name"
    else
        echo -e "${RED}Error: Default $mode theme not found${NC}" >&2
        exit 1
    fi
}

# Interactive selection with live preview (arrow key navigation)
interactive_selection() {
    local themes=($(get_all_themes))
    local current=$(get_current_theme)
    local selected_idx=0
    local visible_count=15
    local scroll_offset=0

    # Find current theme index
    local i=0
    for theme in "${themes[@]}"; do
        if [[ "$theme" == "$current" ]]; then
            selected_idx=$i
            break
        fi
        ((i++))
    done

    # Start with current theme in view
    scroll_offset=$((selected_idx > visible_count - 3 ? selected_idx - visible_count + 3 : 0))

    # Start preview window with initial theme
    start_preview_window "${themes[$selected_idx]}"

    # Save terminal settings
    stty_save=$(stty -g 2>/dev/null || true)

    # Set raw mode for immediate input
    stty -icanon -echo 2>/dev/null || true

    # Handle Ctrl+C
    trap 'stty "$stty_save" 2>/dev/null || true; stop_preview_window; exit 0' INT

    while true; do
        clear

        # Header
        echo -e "${CYAN}${BOLD}╔═══════════════════════════════════════════╗${NC}"
        echo -e "${CYAN}${BOLD}║       Ghostty Theme Switcher             ║${NC}"
        echo -e "${CYAN}${BOLD}╚═══════════════════════════════════════════╝${NC}"
        echo -e "${YELLOW}Current: ${BOLD}$current${NC}  |  ${GREEN}Previewing: ${BOLD}${themes[$selected_idx]}${NC}"
        echo ""

        # Display visible themes
        local end=$((scroll_offset + visible_count))
        if [[ $end -gt ${#themes[@]} ]]; then
            end=${#themes[@]}
        fi

        for ((i=scroll_offset; i<end; i++)); do
            local theme="${themes[$i]}"
            local marker=" "

            if [[ $i -eq $selected_idx ]]; then
                marker="${GREEN}►${NC}"
                echo -e "${GREEN}▶${NC} ${BOLD}$theme${NC}"
            else
                echo "  $theme"
            fi
        done

        # Footer
        echo ""
        echo -e "${BOLD}[$((selected_idx + 1))/${#themes[@]}]${NC}"
        echo ""
        echo -e "  ${GREEN}[↑↓]${NC} Navigate    ${GREEN}[Enter]${NC} Apply    ${YELLOW}[Home/End]${NC} First/Last"
        echo -e "  ${YELLOW}[PgUp/PgDn]${NC} Page    ${RED}[Esc/q]${NC} Cancel"
        echo ""

        # Read single character
        read -n 1 key 2>/dev/null || key=""

        case "$key" in
            $'\x1b')  # ESC sequence (arrow keys, etc)
                read -n 2 -t 0.1 rest 2>/dev/null || rest=""

                case "$rest" in
                    '[A') # Up arrow
                        ((selected_idx--))
                        ;;
                    '[B') # Down arrow
                        ((selected_idx++))
                        ;;
                    '[5') # Page Up
                        read -n 1 -t 0.1 t 2>/dev/null || true
                        ((selected_idx -= visible_count))
                        ;;
                    '[6') # Page Down
                        read -n 1 -t 0.1 t 2>/dev/null || true
                        ((selected_idx += visible_count))
                        ;;
                    '[H') # Home
                        selected_idx=0
                        ;;
                    '[F') # End
                        selected_idx=$((${#themes[@]} - 1))
                        ;;
                    *) # Just ESC
                        stty "$stty_save" 2>/dev/null || true
                        stop_preview_window
                        echo "Cancelled"
                        exit 0
                        ;;
                esac
                ;;
            '') # Enter
                stty "$stty_save" 2>/dev/null || true
                apply_from_preview "${themes[$selected_idx]}"
                exit 0
                ;;
            'q'|'Q')
                stty "$stty_save" 2>/dev/null || true
                stop_preview_window
                echo "Cancelled"
                exit 0
                ;;
        esac

        # Bounds checking
        if [[ $selected_idx -lt 0 ]]; then
            selected_idx=0
        elif [[ $selected_idx -ge ${#themes[@]} ]]; then
            selected_idx=$((${#themes[@]} - 1))
        fi

        # Update scroll offset
        if [[ $selected_idx -lt $scroll_offset ]]; then
            scroll_offset=$selected_idx
        elif [[ $selected_idx -ge $((scroll_offset + visible_count - 1)) ]]; then
            scroll_offset=$((selected_idx - visible_count + 2))
        fi

        # Update preview
        update_preview_theme "${themes[$selected_idx]}"
    done
}

# Main
case "$1" in
    ""|"-i"|"--interactive")
        interactive_selection
        ;;
    "list"|"--list"|"-l")
        list_themes
        ;;
    "current"|"--current"|"-c")
        echo -e "${CYAN}Current theme:${NC} ${BOLD}$(get_current_theme)${NC}"
        ;;
    "random"|"--random"|"-r")
        set_random_theme
        ;;
    "light"|"--light")
        set_mode_theme "light"
        ;;
    "dark"|"--dark")
        set_mode_theme "dark"
        ;;
    "--no-preview")
        if [[ -z "$2" ]]; then
            echo -e "${RED}Error: --no-preview requires a theme name${NC}" >&2
            exit 1
        fi
        apply_theme_directly "$2"
        ;;
    "version"|"--version"|"-v")
        echo "ghostty-theme v${VERSION}"
        ;;
    "help"|"--help"|"-h")
        usage
        ;;
    *)
        preview_and_apply_theme "$*"
        ;;
esac

#!/bin/bash
# Ghostty Theme Switcher
# https://github.com/yourusername/ghostty-theme-switch

set -e

VERSION="2.1.0"

# Config file location
CONFIG_FILE="$HOME/Library/Application Support/com.mitchellh.ghostty/config"
if [[ ! -f "$CONFIG_FILE" ]]; then
    CONFIG_FILE="$XDG_CONFIG_HOME/ghostty/config"
fi
if [[ ! -f "$CONFIG_FILE" ]]; then
    CONFIG_FILE="$HOME/.config/ghostty/config"
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Find Ghostty executable
if [[ "$OSTYPE" == "darwin"* ]] && [[ -x "/Applications/Ghostty.app/Contents/MacOS/ghostty" ]]; then
    GHOSTTY_EXEC="/Applications/Ghostty.app/Contents/MacOS/ghostty"
elif [[ "$OSTYPE" == "darwin"* ]] && [[ -x "$HOME/Applications/Ghostty.app/Contents/MacOS/ghostty" ]]; then
    GHOSTTY_EXEC="$HOME/Applications/Ghostty.app/Contents/MacOS/ghostty"
else
    GHOSTTY_EXEC="ghostty"
fi

# Usage
usage() {
    echo -e "${CYAN}Ghostty Theme Switcher${NC} v${VERSION}"
    echo ""
    echo "Usage:"
    echo "  ghostty-theme                    Interactive theme selector"
    echo "  ghostty-theme list               List all themes"
    echo "  ghostty-theme current            Show current theme"
    echo "  ghostty-theme <theme-name>       Apply specific theme"
    echo "  ghostty-theme random             Apply random theme"
    echo "  ghostty-theme light/dark         Apply light/dark theme"
    echo "  ghostty-theme version            Show version"
    echo ""
    echo "Examples:"
    echo "  ghostty-theme                    # Interactive selector"
    echo "  ghostty-theme \"Dracula\"          # Apply Dracula theme"
    echo "  ghostty-theme random             # Random theme"
}

# Get current theme
get_current_theme() {
    if [[ -f "$CONFIG_FILE" ]]; then
        awk -F'= *' '/^theme[[:space:]]*=/ {print $2}' "$CONFIG_FILE" | tr -d '"' | tr -d "'"
    else
        echo "Unknown"
    fi
}

# List themes
list_themes() {
    local current=$(get_current_theme)
    echo -e "${BOLD}Available themes:${NC}"
    echo ""
    ghostty +list-themes 2>/dev/null | sed 's/ (resources)$//' | sort | while read -r theme; do
        if [[ "$theme" == "$current" ]]; then
            echo -e "  ${GREEN}●${NC} $theme ${CYAN}(current)${NC}"
        else
            echo -e "  ○ $theme"
        fi
    done
}

# Apply theme to config
apply_theme() {
    local new_theme="$1"
    cp "$CONFIG_FILE" "$CONFIG_FILE.bak"

    if grep -qE "^theme[[:space:]]*=" "$CONFIG_FILE"; then
        awk -v new_theme="$new_theme" '/^theme[[:space:]]*=/ {$0 = "theme = " new_theme} 1' "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
    else
        echo "theme = $new_theme" >> "$CONFIG_FILE"
    fi

    echo -e "${GREEN}✓ Applied: ${BOLD}$new_theme${NC}"
    echo -e "${YELLOW}Press ${BOLD}Cmd+Shift+${NC},${YELLOW} to reload${NC}"
}

# Get all themes
get_all_themes() {
    ghostty +list-themes 2>/dev/null | sed 's/ (resources)$//' | sort
}

# Apply theme directly
apply_direct() {
    local new_theme="$1"

    # Verify theme exists
    if ! get_all_themes | grep -qx "$new_theme"; then
        echo -e "${RED}Error: Theme '$new_theme' not found${NC}" >&2
        echo -e "${YELLOW}Use 'ghostty-theme list' to see available themes${NC}" >&2
        exit 1
    fi

    apply_theme "$new_theme"
}

# Set random theme
set_random_theme() {
    local all_themes=()
    while IFS= read -r line; do
        all_themes+=("$line")
    done < <(get_all_themes)
    local count=${#all_themes[@]}
    apply_theme "${all_themes[$((RANDOM % count))]}"
}

# Set light/dark theme
set_mode_theme() {
    local mode="$1"
    local theme_name="Github Light"
    [[ "$mode" == "dark" ]] && theme_name="Dracula"
    apply_theme "$theme_name"
}

# Simple selector (fallback when fzf not available)
simple_select() {
    local current=$(get_current_theme)
    local -a themes
    while IFS= read -r line; do
        themes+=("$line")
    done < <(get_all_themes)

    local page_size=20
    local page=0
    local total_pages=$(( (${#themes[@]} + page_size - 1) / page_size ))
    local selected=0

    while true; do
        clear
        echo -e "${CYAN}${BOLD}╔═══════════════════════════════════════════╗${NC}"
        echo -e "${CYAN}${BOLD}║       Ghostty Theme Selector              ║${NC}"
        echo -e "${CYAN}${BOLD}╚═══════════════════════════════════════════╝${NC}"
        echo ""
        echo -e "${BOLD}Page $((page + 1))/$total_pages${NC} - ${YELLOW}n/p${NC} for next/prev page, ${YELLOW}q${NC} to quit"
        echo ""

        local start=$((page * page_size))
        local end=$((start + page_size))
        if [[ $end -gt ${#themes[@]} ]]; then
            end=${#themes[@]}
        fi

        for ((i=start; i<end; i++)); do
            local num=$((i + 1))
            if [[ "${themes[$i]}" == "$current" ]]; then
                echo -e "  ${GREEN}[$num]${NC} ${themes[$i]} ${CYAN}(current)${NC}"
            else
                echo -e "  [$num] ${themes[$i]}"
            fi
        done

        echo ""
        echo -ne "${YELLOW}Enter number to apply (or n/p/q): ${NC}"

        local input
        read input

        case "$input" in
            q|Q|exit)
                echo ""
                echo "No changes made"
                exit 0
                ;;
            n|N|next)
                if [[ $page -lt $((total_pages - 1)) ]]; then
                    ((page++))
                fi
                ;;
            p|P|prev)
                if [[ $page -gt 0 ]]; then
                    ((page--))
                fi
                ;;
            *)
                if [[ "$input" =~ ^[0-9]+$ ]] && [[ $input -ge 1 ]] && [[ $input -le ${#themes[@]} ]]; then
                    apply_theme "${themes[$((input - 1))]}"
                    exit 0
                else
                    echo -e "${RED}Invalid selection${NC}"
                    sleep 1
                fi
                ;;
        esac
    done
}

# fzf selector
fzf_select() {
    local current=$(get_current_theme)
    local selected

    selected=$(get_all_themes | \
        fzf --height=60% \
            --prompt="Theme> " \
            --query="$current" \
            --header="[Enter] Apply | [Esc] Cancel" \
            --border=rounded \
            --marker="●" \
            --pointer="→" \
            --color=header:cyan,pointer:cyan,marker:green \
            --preview-window=hidden)

    if [[ -n "$selected" ]]; then
        apply_theme "$selected"
    else
        echo "No theme selected"
    fi
}

# Main interactive selector
interactive_select() {
    echo -e "${CYAN}Ghostty Theme Selector${NC} v${VERSION}"
    echo ""

    if command -v fzf &>/dev/null; then
        fzf_select
    else
        echo -e "${YELLOW}fzf not found. Using simple selector...${NC}"
        echo -e "${CYAN}Tip: Install fzf for better experience${NC}"
        echo ""
        sleep 1
        simple_select
    fi
}

# Main
case "$1" in
    ""|"-i"|"--interactive")
        interactive_select
        ;;
    "list"|"--list"|"-l")
        list_themes
        ;;
    "current"|"--current"|"-c")
        echo -e "${CYAN}Current theme:${NC} ${BOLD}$(get_current_theme)${NC}"
        ;;
    "random"|"--random"|"-r")
        set_random_theme
        ;;
    "light"|"--light")
        set_mode_theme "light"
        ;;
    "dark"|"--dark")
        set_mode_theme "dark"
        ;;
    "version"|"--version"|"-v")
        echo "ghostty-theme v${VERSION}"
        ;;
    "help"|"--help"|"-h")
        usage
        ;;
    *)
        apply_direct "$*"
        ;;
esac
